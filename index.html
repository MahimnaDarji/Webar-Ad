<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebAR Ad â€” Auto Fit (Any Print Size)</title>

  <!-- A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <!-- MindAR (image tracking) for A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin: 0; height: 100%; background: #000; }

    /* Camera preview */
    #camPreview{
      position: fixed; inset: 0;
      width: 100vw; height: 100vh;
      object-fit: cover; z-index: 0; background: #000;
    }

    /* AR scene */
    a-scene{ position: fixed; inset: 0; z-index: 1; }

    /* Hint above the scanner */
    .hint{
      position: fixed; left: 50%; top: 18%; transform: translateX(-50%);
      z-index: 20; padding: 10px 16px; border-radius: 12px; color: #fff;
      font: 700 20px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: rgba(0,0,0,0.5); text-align: center; text-shadow: 0 2px 3px rgba(0,0,0,.6);
      pointer-events: none;
    }
    .hint.hidden{ display:none; }

    /* Action buttons */
    .actions{
      position: fixed; right: 12px; top: 12px; z-index: 30;
      display: flex; gap: 8px; flex-wrap: wrap;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .btn{
      padding: 10px 14px; border-radius: 12px;
      background: rgba(20,20,20,0.85); color: #fff;
      border: 1px solid #3a3a3a; cursor: pointer; backdrop-filter: blur(6px);
      font-weight: 600; font-size: 14px;
    }
    .btn:hover{ background: rgba(30,30,30,0.9); }
    #pickInput{ display:none; }

    /* ===== Screen Mode (scan image on this device) ===== */
    #screenMode{
      position: fixed; inset: 0; z-index: 25; display: none; background: #000;
    }
    #screenImg{
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      max-width: 92vw; max-height: 92vh; border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.6);
    }
    #screenVideo{
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.6);
      width: 0; height: 0; object-fit: cover; /* JS sets correct size */
    }
    #screenClose{
      position: absolute; right: 16px; top: 16px; z-index: 26;
      padding: 8px 10px; border-radius: 10px; border: 1px solid #3a3a3a;
      background: rgba(25,25,25,0.9); color: #fff; cursor: pointer; font-weight: 600;
    }
    /* Tap-to-play for mobile autoplay restrictions */
    #tapToPlay{
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      z-index: 27; display: none; padding: 12px 16px; border-radius: 12px;
      background: rgba(20,20,20,0.85); color: #fff; border: 1px solid #3a3a3a;
      font: 700 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
  </style>
</head>
<body>
  <!-- Camera preview -->
  <video id="camPreview" autoplay playsinline muted></video>

  <!-- Instruction text ABOVE scanner -->
  <div id="hint" class="hint">Point your camera at your printed ad</div>

  <!-- Actions: pick image (screen mode) + back to camera -->
  <div class="actions">
    <button id="pickBtn" class="btn">Use image from gallery</button>
    <button id="backToCamera" class="btn" style="display:none;">Back to camera</button>
    <input id="pickInput" type="file" accept="image/*" />
  </div>

  <!-- ===== Screen Mode (user-selected image on this device) ===== -->
  <div id="screenMode" aria-hidden="true">
    <button id="screenClose">Back to camera</button>
    <img id="screenImg" alt="Selected image" />
    <video id="screenVideo" autoplay muted playsinline loop></video>
    <button id="tapToPlay">Tap to play</button>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: ./assets/ad.mind;
                  filterMinCF: 0.0005;
                  filterBeta: 0.01;
                  warmupTolerance: 5;
                  missTolerance: 7"
    color-space="sRGB"
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true; antialias: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-assets>
      <img id="adImage" src="./assets/ad.png" crossorigin="anonymous">
      <video id="adVideo" src="./assets/ad.mp4" preload="auto"
             webkit-playsinline playsinline muted loop crossorigin="anonymous"></video>
    </a-assets>

    <!-- Default MindAR scanner shows -->
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity id="targetRoot" mindar-image-target="targetIndex: 0">
      <a-plane id="adPlane" src="#adImage" position="0 0 0"
               rotation="0 0 0" width="1" height="0.56"></a-plane>

      <a-plane id="videoPlane"
               material="shader: flat; src: #adVideo"
               position="0 0 0.001" rotation="0 0 0"
               width="1" height="0.56"></a-plane>
    </a-entity>
  </a-scene>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const scene   = document.querySelector('a-scene');
      const preview = document.getElementById('camPreview');
      const hint    = document.getElementById('hint');
      const root    = document.getElementById('targetRoot');
      const adImg   = document.getElementById('adImage');
      const adPlane = document.getElementById('adPlane');
      const video   = document.getElementById('adVideo');
      const videoPlane = document.getElementById('videoPlane');

      // CAMERA MODE helpers
      const attachPreview = () => {
        try {
          const ms = scene.systems['mindar-image-system'];
          if (ms && ms.video && ms.video.srcObject) {
            preview.srcObject = ms.video.srcObject;
            return true;
          }
        } catch (e) {}
        return false;
      };
      const tryAttach = () => { if (!attachPreview()) setTimeout(tryAttach,150); };
      scene.addEventListener('loaded', tryAttach);

      // Hide spinner when ready/error
      scene.addEventListener('arReady', () => {
        const el = document.querySelector('.mindar-ui-loading');
        if (el) el.style.display = 'none';
      });
      scene.addEventListener('arError', () => {
        const el = document.querySelector('.mindar-ui-loading');
        if (el) el.style.display = 'none';
      });

      // Fit planes and crop texture (cover)
      function getVideoMap(){
        const mesh = videoPlane.getObject3D('mesh');
        return (mesh && mesh.material && mesh.material.map) ? mesh.material.map : null;
      }
      function fitPlanesCover(){
        const adAspect = adImg.naturalWidth / adImg.naturalHeight;
        const videoAspect = (video.videoWidth||16)/(video.videoHeight||9);

        const adW=1.0, adH=adW/adAspect;
        adPlane.setAttribute('width',adW);
        adPlane.setAttribute('height',adH);
        videoPlane.setAttribute('width',adW);
        videoPlane.setAttribute('height',adH);

        const map=getVideoMap();
        if(!map){ setTimeout(fitPlanesCover,50); return; }
        if(map.center) map.center.set(0.5,0.5);
        if(videoAspect>adAspect){
          const showX=adAspect/videoAspect;
          map.repeat.set(showX,1);
          map.offset.set((1-showX)/2,0);
        } else {
          const showY=videoAspect/adAspect;
          map.repeat.set(1,showY);
          map.offset.set(0,(1-showY)/2);
        }
        map.needsUpdate=true;
      }
      function whenReady(){
        if(adImg.complete&&adImg.naturalWidth>0&&video.readyState>=1){
          fitPlanesCover();
        }else setTimeout(whenReady,60);
      }
      adImg.addEventListener('load',whenReady);
      video.addEventListener('loadedmetadata',whenReady);
      whenReady();

      root.addEventListener('targetFound', async ()=>{
        hint.classList.add('hidden');
        try{ await video.play(); }
        catch(e){
          const resume=()=>{ video.play().catch(()=>{}); window.removeEventListener('touchend',resume); window.removeEventListener('click',resume); };
          window.addEventListener('touchend',resume,{once:true});
          window.addEventListener('click',resume,{once:true});
        }
      });
      root.addEventListener('targetLost',()=>{ hint.classList.remove('hidden'); video.pause(); });

      // ===== SCREEN MODE =====
      const pickBtn = document.getElementById('pickBtn');
      const pickInput = document.getElementById('pickInput');
      const backBtn = document.getElementById('backToCamera');

      const screenMode = document.getElementById('screenMode');
      const screenImg  = document.getElementById('screenImg');
      const screenVid  = document.getElementById('screenVideo');
      const tapToPlay  = document.getElementById('tapToPlay');
      const screenClose= document.getElementById('screenClose');

      // Use the same video
      screenVid.src = video.getAttribute('src');
      screenVid.load();

      // Pause MindAR/camera when entering screen mode; resume on exit
      function stopAR(){
        try{
          const ms = scene.systems['mindar-image-system'];
          ms && ms.stop && ms.stop();
        }catch(e){}
        // Also pause the camera <video> element if present
        if (preview && preview.srcObject) {
          const tracks = preview.srcObject.getTracks ? preview.srcObject.getTracks() : [];
          tracks.forEach(t => t.stop && t.stop());
        }
      }
      function startAR(){
        try{
          const ms = scene.systems['mindar-image-system'];
          ms && ms.start && ms.start();
        }catch(e){}
      }

      function fitScreenOverlay(){
        const r = screenImg.getBoundingClientRect();
        screenVid.style.width  = r.width  + 'px';
        screenVid.style.height = r.height + 'px';
        screenVid.style.left   = (r.left + r.width/2) + 'px';
        screenVid.style.top    = (r.top  + r.height/2) + 'px';
        screenVid.style.transform = 'translate(-50%, -50%)';
      }
      window.addEventListener('resize', ()=>{ if(screenMode.style.display==='block') fitScreenOverlay(); });

      function enterScreenMode(blobURL){
        // 1) Stop AR/camera to avoid conflicts on mobile
        stopAR();
        // 2) Show UI
        screenImg.onload = ()=>{
          // Wait one frame so layout is correct
          requestAnimationFrame(()=>{
            fitScreenOverlay();
            tryPlayScreenVideo();
          });
        };
        screenImg.src = blobURL;
        screenMode.style.display = 'block';
        backBtn.style.display = 'inline-block';
      }

      function exitScreenMode(){
        screenMode.style.display = 'none';
        backBtn.style.display = 'none';
        tapToPlay.style.display = 'none';
        screenVid.pause();
        // free any object URL used for the image
        if (screenImg.src.startsWith('blob:')) URL.revokeObjectURL(screenImg.src);
        screenImg.removeAttribute('src');
        // 3) Restart AR/camera
        startAR();
        // Reattach preview after MindAR restarts
        setTimeout(tryAttach, 300);
      }

      async function tryPlayScreenVideo(){
        tapToPlay.style.display = 'none';
        // iOS often requires a user gesture even with muted+playsinline.
        // file selection counts as a gesture, but we still guard with catch.
        try {
          await screenVid.play();
        } catch (e) {
          tapToPlay.style.display = 'inline-block';
        }
      }

      pickBtn.addEventListener('click', ()=> pickInput.click());
      pickInput.addEventListener('change', ()=>{
        const f = pickInput.files && pickInput.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        enterScreenMode(url);
      });

      screenClose.addEventListener('click', exitScreenMode);
      backBtn.addEventListener('click',  exitScreenMode);
      tapToPlay.addEventListener('click', tryPlayScreenVideo);
    });
  </script>
</body>
</html>
