<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebAR Ad — Video Overlay</title>

  <!-- A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <!-- MindAR (image tracking) for A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin: 0; height: 100%; background: #000; }
    .ui, .footer {
      position: fixed; left: 0; right: 0; z-index: 10; color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; text-align: center;
    }
    .ui { top: 0; padding: 10px 14px; background: linear-gradient(rgba(0,0,0,.55), rgba(0,0,0,0)); }
    .footer { bottom: 0; padding: 10px 14px; background: linear-gradient(rgba(0,0,0,0), rgba(0,0,0,.55)); font-size: 13px; }
  </style>
</head>
<body>
  <div class="ui">Point your camera at your printed ad (or open <code>/assets/ad.png</code> on another screen)</div>
  <div class="footer">Serve from <strong>http://localhost</strong> (or HTTPS later). Allow camera access.</div>

  <a-scene
    mindar-image="imageTargetSrc: ./assets/ad.mind"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <!-- Assets: your ad image (for alignment) + your video -->
    <a-assets>
      <img id="adImage" src="./assets/ad.png" crossorigin="anonymous">
      <!-- IMPORTANT: muted + playsinline enable auto-play on mobile -->
      <video id="adVideo" src="./assets/ad.mp4" preload="auto" webkit-playsinline playsinline muted loop crossorigin="anonymous"></video>
    </a-assets>

    <!-- Required camera -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Target content -->
    <a-entity id="targetRoot" mindar-image-target="targetIndex: 0">
      <!-- Optionally keep the image plane underneath for quick visual alignment -->
      <!-- Set width=1 (MindAR units). Adjust height to match your ad aspect ratio. -->
      <!-- You can comment this plane out later if you want only the video. -->
      <a-plane src="#adImage" position="0 0 0" rotation="0 0 0" width="1" height="0.56"></a-plane>

      <!-- Video mapped onto a plane. Match its size/aspect to your ad. -->
      <!-- Place it slightly above the image plane (small +z offset) so it renders on top. -->
      <a-plane id="videoPlane"
               material="shader: flat; src: #adVideo"
               position="0 0 0.001"
               rotation="0 0 0"
               width="1"
               height="0.56">
      </a-plane>

      <!-- Label (optional) -->
      <a-text value="Playing…" align="center" position="0 -0.7 0.001" scale="0.6 0.6 0.6" color="#ffffff"></a-text>
    </a-entity>
  </a-scene>

  <script>
    // Auto play/pause the video when the target is found/lost
    window.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      const root = document.getElementById('targetRoot');
      const video = document.getElementById('adVideo');

      // Some browsers need an explicit load() before first play
      video.load();

      root.addEventListener('targetFound', async () => {
        try {
          await video.play();
          // console.log('Video playing');
        } catch (e) {
          // Autoplay blocked? Tap anywhere to play.
          console.warn('Autoplay blocked, waiting for user gesture');
          const resume = () => {
            video.play().catch(()=>{});
            window.removeEventListener('touchend', resume);
            window.removeEventListener('click', resume);
          };
          window.addEventListener('touchend', resume, { once: true });
          window.addEventListener('click', resume, { once: true });
        }
      });

      root.addEventListener('targetLost', () => {
        video.pause();
        // Optional: reset to start
        // video.currentTime = 0;
      });

      // Helpful: when scene is loaded, ensure media is ready
      scene.addEventListener('loaded', () => {
        // iOS sometimes needs a muted play "kick"
        video.muted = true;
      });
    });
  </script>
</body>
</html>